import React, { useState } from 'react';
import { ChevronDown, ChevronUp, Plus, MoreHorizontal, Copy, Flag, MessageCircle, Search, HelpCircle } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import FactCheckNote from './FactCheckNote';

const positiveEmojis = ['ðŸ”¥', 'ðŸ’¯', 'ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ’ª', 'ðŸ‘', 'ðŸ˜', 'ðŸŽ¯', 'ðŸ’¡'];
const negativeEmojis = ['ðŸ‘Ž', 'ðŸ¤¡', 'ðŸ’©', 'ðŸ˜¡', 'ðŸ™„', 'ðŸ¤¦'];

export function classifyEmoji(emoji) {
  if (positiveEmojis.includes(emoji)) return 'positive';
  if (negativeEmojis.includes(emoji)) return 'negative';
  return 'neutral';
}

// Format long text with proper paragraphs and spacing
function formatLongText(text) {
  if (!text) return text;
  
  // Split by existing double line breaks first
  const existingParagraphs = text.split(/\n\n+/);
  if (existingParagraphs.length > 1) {
    return existingParagraphs.map(p => p.trim()).filter(Boolean).join('\n\n');
  }
  
  // For single-block text longer than 150 chars, create natural paragraph breaks
  if (text.length < 150) return text;
  
  const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
  if (sentences.length < 4) return text;
  
  const paragraphs = [];
  let currentParagraph = '';
  
  sentences.forEach((sentence, idx) => {
    currentParagraph += sentence.trim() + ' ';
    // Break every 2-3 sentences for readability
    if ((idx + 1) % 3 === 0 && idx < sentences.length - 1) {
      paragraphs.push(currentParagraph.trim());
      currentParagraph = '';
    }
  });
  
  if (currentParagraph.trim()) {
    paragraphs.push(currentParagraph.trim());
  }
  
  return paragraphs.join('\n\n');
}

// Check if text contains a question
function containsQuestion(text) {
  return text && text.includes('?');
}

export default function ArgumentBubble({ 
  text, 
  side, 
  index, 
  reactions = {}, 
  onAddReaction,
  onComment,
  onFactCheck,
  onReport,
  readonly = false,
  factCheck = null
}) {
  const [isHovered, setIsHovered] = useState(false);
  const [showPicker, setShowPicker] = useState(false);
  const [showContextMenu, setShowContextMenu] = useState(false);
  const [contextMenuPos, setContextMenuPos] = useState({ x: 0, y: 0 });
  
  const isUser = side === 'user';
  const formattedText = formatLongText(text);
  const isLong = text.length > 350;
  const hasQuestion = containsQuestion(text);
  const allEmojis = [...positiveEmojis, ...negativeEmojis];

  // Calculate score
  let score = 0;
  Object.entries(reactions).forEach(([emoji, count]) => {
    const sentiment = classifyEmoji(emoji);
    if (sentiment === 'positive') score += count;
    if (sentiment === 'negative') score -= count;
  });

  let scoreModifier = 0;
  if (factCheck) {
    if (factCheck.status === 'verified') scoreModifier = 2;
    else if (factCheck.status === 'incorrect') scoreModifier = -5;
  }
  const finalScore = score + scoreModifier;

  const scoreColor = finalScore > 0 ? 'bg-emerald-500' : finalScore < 0 ? 'bg-rose-500' : 'bg-gray-400';
  const bubbleStyle = isUser 
    ? 'bg-gradient-to-br from-emerald-50 to-emerald-100/50 border-emerald-200' 
    : 'bg-gradient-to-br from-rose-50 to-rose-100/50 border-rose-200';

  const showExpanded = isHovered;

  const handleContextMenu = (e) => {
    e.preventDefault();
    setContextMenuPos({ x: e.clientX, y: e.clientY });
    setShowContextMenu(true);
  };

  const closeContextMenu = () => {
    setShowContextMenu(false);
  };

  const copyText = () => {
    navigator.clipboard.writeText(text);
    closeContextMenu();
  };

  return (
    <div 
      className={`relative ${isUser ? 'pr-4' : 'pl-4'}`}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => {
        setIsHovered(false);
        setShowPicker(false);
      }}
      onContextMenu={handleContextMenu}
    >
      {/* Context Menu Overlay */}
      {showContextMenu && (
        <div 
          className="fixed inset-0 z-50" 
          onClick={closeContextMenu}
        >
          <div 
            className="absolute bg-white rounded-xl shadow-2xl border border-gray-200 py-2 min-w-[180px] z-50"
            style={{ 
              left: Math.min(contextMenuPos.x, window.innerWidth - 200), 
              top: Math.min(contextMenuPos.y, window.innerHeight - 250) 
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <button
              onClick={() => { onComment?.(); closeContextMenu(); }}
              className="w-full px-4 py-2.5 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
            >
              <MessageCircle className="w-4 h-4 text-gray-400" /> Comment on argument
            </button>
            <button
              onClick={() => { onFactCheck?.(); closeContextMenu(); }}
              className="w-full px-4 py-2.5 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
            >
              <Search className="w-4 h-4 text-gray-400" /> Fact-check argument
            </button>
            <div className="h-px bg-gray-100 my-1" />
            <div className="px-4 py-2">
              <div className="text-xs text-gray-400 mb-2">React</div>
              <div className="flex flex-wrap gap-1">
                {allEmojis.slice(0, 8).map(emoji => (
                  <button
                    key={emoji}
                    onClick={() => { onAddReaction?.(emoji); closeContextMenu(); }}
                    className="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-lg text-lg"
                  >
 
