import React, { useState } from 'react';
import { Shuffle, Sparkles, ChevronLeft, Loader2 } from 'lucide-react';
import { base44 } from '@/api/base44Client';

const topicCategories = {
  'Life & Society': [
    "Marriage is an outdated institution",
    "Social media has made us lonelier",
    "Success is more about luck than hard work",
    "Living in cities is better than rural areas"
  ],
  'Religion & Faith': [
    "Religion does more harm than good in modern society",
    "Faith and science can coexist",
    "Organized religion should be taxed",
    "Spirituality is essential for human wellbeing"
  ],
  'Philosophy': [
    "Free will is an illusion",
    "Morality is subjective, not objective",
    "The meaning of life is self-created",
    "Ignorance can be bliss"
  ],
  'Politics': [
    "Democracy is the best form of government",
    "Voting should be mandatory",
    "Political correctness has gone too far",
    "Nationalism is dangerous in the modern world"
  ],
  'Technology & AI': [
    "AI will replace most human jobs within 20 years",
    "Social media should be regulated like tobacco",
    "Privacy is more important than convenience",
    "Technology is making us less intelligent"
  ],
  'Sports': [
    "Esports deserve the same recognition as traditional sports",
    "Professional athletes are overpaid",
    "Performance-enhancing drugs should be allowed in sports",
    "Youth sports are too competitive"
  ],
  'Relationships': [
    "Long-distance relationships can work",
    "Couples should live together before marriage",
    "Romantic love is overrated",
    "Friendship is more important than romance"
  ],
  'Ethics & Morality': [
    "The death penalty is never justified",
    "White lies are morally acceptable",
    "Wealthy people have a moral obligation to give to charity",
    "Animals should have the same rights as humans"
  ],
  'Culture & Entertainment': [
    "Video games are a legitimate art form",
    "Cancel culture has gone too far",
    "Classic literature is still relevant today",
    "Streaming killed the music industry"
  ],
  'Economics & Money': [
    "Universal basic income should be implemented",
    "Cryptocurrency will replace traditional currency",
    "College education is no longer worth the cost",
    "Billionaires should not exist"
  ]
};

const categoryList = Object.keys(topicCategories);

export default function TopicSelector({ value, onChange }) {
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);

  const selectRandomCategory = () => {
    const randomCat = categoryList[Math.floor(Math.random() * categoryList.length)];
    setSelectedCategory(randomCat);
    setShowSuggestions(true);
  };

  const selectTopicFromCategory = (topic) => {
    onChange(topic);
    setShowSuggestions(false);
    setSelectedCategory(null);
  };

  const generateRandomFromCategory = async () => {
    if (!selectedCategory) return;
    setIsGenerating(true);
    
    try {
      const response = await base44.integrations.Core.InvokeLLM({
        prompt: `Generate ONE unique debate topic for the category "${selectedCategory}".
The topic must be:
- Debatable (can argue for OR against)
- Neutral in wording (not biased toward either side)
- Clear and concise
- Different from these existing topics: ${topicCategories[selectedCategory].join(', ')}

Return ONLY the topic text, nothing else.`,
        response_json_schema: {
          type: "object",
          properties: { topic: { type: "string" } },
          required: ["topic"]
        }
      });
      
      if (response?.topic) {
        onChange(response.topic);
        setShowSuggestions(false);
        setSelectedCategory(null);
      }
    } catch (error) {
      // Fallback to random from list
      const topics = topicCategories[selectedCategory];
      onChange(topics[Math.floor(Math.random() * topics.length)]);
      setShowSuggestions(false);
      setSelectedCategory(null);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="space-y-2">
      <label className="text-sm font-semibold text-gray-700">Debate Topic</label>
      
      <div className="relative">
        <textarea
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder="Enter your debate topic..."
          className="w-full p-4 pr-12 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-orange-400 resize-none text-sm"
          rows={2}
        />
        <button
          onClick={selectRandomCategory}
          className="absolute right-3 top-3 p-2 bg-orange-100 hover:bg-orange-200 rounded-lg transition-colors"
          title="Random topic"
        >
          <Shuffle className="w-4 h-4 text-orange-600" />
        </button>
      </div>

      <button
        onClick={() => {
          setShowSuggestions(!showSuggestions);
          setSelectedCategory(null);
        }}
        className="flex items-center gap-2 text-sm text-orange-600 hover:text-orange-700 font-medium"
      >
        <Sparkles className="w-4 h-4" />
        {showSuggestions ? 'Hide categories' : 'Browse topic categories'}
      </button>

      {/* Category Selection */}
      {showSuggestions && !selectedCategory && (
        <div className="bg-gray-50 rounded-xl p-3 space-y-2 max-h-64 overflow-y-auto">
          <div className="text-xs font-semibold text-gray-500 px-1 mb-2">Select a category</div>
          <div className="grid grid-cols-2 gap-2">
            {categoryList.map((cat) => (
              <button
                key={cat}
                onClick={() => setSelectedCategory(cat)}
                className="text-left p-3 bg-white rounded-lg text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 transition-colors border border-gray-100"
              >
                {cat}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Topics from Selected Category */}
      {showSuggestions && selectedCategory && (
        <div className="bg-gray-50 rounded-xl p-3 space-y-2 max-h-72 overflow-y-auto">
          <div className="flex items-center justify-between mb-2">
            <button 
              onClick={() => setSelectedCategory(null)}
              className="flex items-center gap-1 text-xs text-orange-600 hover:text-orange-700 font-medium"
            >
              <ChevronLeft className="w-3 h-3" />
              Back
            </button>
            <span className="text-xs font-semibold text-gray-500">{selectedCategory}</span>
          </div>
          
          <button
            onClick={generateRandomFromCategory}
            disabled={isGenerating}
            className="w-full p-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-lg text-sm font-medium hover:from-orange-600 hover:to-amber-600 transition-colors flex items-center justify-center gap-2"
          >
            {isGenerating ? (
              <><Loader2 className="w-4 h-4 animate-spin" /> Generating...</>
            ) : (
              <><Sparkles className="w-4 h-4" /> Generate New Topic</>
            )}
          </button>
          
          <div className="text-xs text-gray-400 text-center my-2">or choose from suggestions</div>
          
          {topicCategories[selectedCategory].map((topic, idx) => (
            <button
              key={idx}
              onClick={() => selectTopicFromCategory(topic)}
              className={`w-full text-left p-3 rounded-lg text-sm transition-all border ${
                value === topic
                  ? 'bg-orange-100 border-orange-300 text-orange-800'
                  : 'bg-white border-gray-100 text-gray-700 hover:bg-orange-50 hover:text-orange-700'
              }`}
            >
              {topic}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}
